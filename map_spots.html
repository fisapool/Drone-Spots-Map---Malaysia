<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Spots Map - Enhanced (Malaysia)</title>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <style>
        /* Reset html and body margins to ensure header is at top */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden;
        }
        
        /* White layer to cover any gap at top */
        .header-white-layer {
            position: fixed;
            top: -10px;
            left: 0;
            right: 0;
            height: 20px;
            background: white;
            z-index: 49;
        }
        
        /* Ensure nav is at the very top */
        nav.border-4 {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            margin: 0 !important;
            margin-top: 0 !important;
            transform: translateY(0) !important;
        }
        
        /* Custom styles for enhanced map */
        .safety-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.625rem;
            font-weight: 600;
        }
        .safety-badge.high {
            background-color: #dcfce7;
            color: #166534;
        }
        .safety-badge.medium {
            background-color: #fef3c7;
            color: #92400e;
        }
        .safety-badge.low {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .info-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.625rem;
            font-weight: 500;
            background-color: #f3f4f6;
            color: #374151;
        }
        .action-btn {
            transition: all 0.2s ease;
        }
        .action-btn:hover {
            background-color: #000;
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .airport-circle {
            stroke-dasharray: 5, 5;
            animation: dash 20s linear infinite;
        }
        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }
        .custom-marker-icon {
            background: transparent;
            border: none;
        }
        
        /* Make markers more visible (droneDirectory style) */
        .leaflet-marker-icon {
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4));
            transition: transform 0.2s ease;
        }
        
        .leaflet-marker-icon:hover {
            transform: scale(1.15);
            z-index: 1000 !important;
        }
        
        /* Custom popup styling */
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Improve marker cluster visibility (droneDirectory blue) */
        .marker-cluster-small {
            background-color: rgba(0, 71, 171, 0.6) !important;
            color: white !important;
        }
        .marker-cluster-medium {
            background-color: rgba(0, 71, 171, 0.7) !important;
            color: white !important;
        }
        .marker-cluster-large {
            background-color: rgba(0, 71, 171, 0.8) !important;
            color: white !important;
        }
        
        .marker-cluster div {
            background-color: transparent !important;
            color: white !important;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-zinc-100">
    <!-- White layer to cover any gap at top -->
    <div class="header-white-layer"></div>
    
    <!-- Enhanced Navigation Bar (inspired by droneDirectory) -->
    <nav class="border-4 border-black bg-zinc-200 w-full fixed top-0 left-0 right-0 z-50" style="position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; margin: 0 !important; margin-top: 0 !important;">
        <div class="md:flex md:justify-between items-center p-3">
            <div class="flex items-center justify-between w-full md:w-auto">
                <a href="#" class="text-xl font-semibold flex gap-2 items-center justify-center group">
                    <span class="text-2xl">üöÅ</span>
                    <span class="hidden md:inline">Drone Spots Malaysia</span>
                </a>
                <button id="mobileMenuBtn" class="text-3xl md:hidden">‚ò∞</button>
            </div>
            <div id="navMenu" class="hidden md:flex items-center gap-5">
                <button id="btnClustering" class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800">
                    Toggle Clustering
                </button>
                <button id="btnAirports" class="px-4 py-2 border border-black rounded hover:border-gray-400">
                    Toggle Airports
                </button>
            </div>
        </div>
    </nav>
    
    <div class="flex flex-col h-screen pt-16">
        <div class="flex flex-1 overflow-hidden">
            <!-- Map Container -->
            <div id="leafletMapContainer" class="flex-1 w-full h-full"></div>
            
            <!-- Enhanced Sidebar (collapsible, like droneDirectory) -->
            <div id="sidebar" class="w-96 bg-white shadow-lg overflow-y-auto hidden md:block transition-all duration-300">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-2xl font-bold mb-2">Drone Spots Malaysia</h2>
                    <p class="text-sm text-gray-600">Click markers to view details</p>
                    <p class="text-xs text-gray-500 mt-1">üìç Map restricted to Malaysia (including Sabah & Sarawak)</p>
                </div>
                
                <!-- Search Section -->
                <div class="p-4 border-b border-gray-200">
                    <div class="flex gap-2 mb-2">
                        <input 
                            type="text" 
                            id="locationSearch" 
                            placeholder="Enter location (e.g., Kuala Lumpur)" 
                            class="flex-1 px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <button 
                            id="searchBtn" 
                            onclick="searchLocation()"
                            class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800"
                        >
                            Search
                        </button>
                    </div>
                    <input 
                        type="search" 
                        id="searchInput" 
                        placeholder="Filter loaded spots..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                        oninput="filterSpots()"
                    />
                    <div id="searchResultsInfo" class="mt-2 text-sm text-gray-600 hidden"></div>
                </div>
                
                <!-- Stats Section -->
                <div id="stats" class="p-4 border-b border-gray-200 grid grid-cols-2 gap-4 hidden">
                    <div class="bg-zinc-100 p-3 rounded">
                        <div class="text-2xl font-bold" id="totalSpots">0</div>
                        <div class="text-sm text-gray-600">Total Spots</div>
                    </div>
                    <div class="bg-zinc-100 p-3 rounded">
                        <div class="text-2xl font-bold" id="avgSafety">0</div>
                        <div class="text-sm text-gray-600">Avg Safety</div>
                    </div>
                </div>
                
                <!-- Spots List -->
                <div id="spotsList" class="p-4"></div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet.js -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet MarkerCluster -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script>
        let leafletMap = null;
        let markerCluster = null; // Marker cluster group
        let leafletMarkers = [];
        let airportMarkers = [];
        let airportCircles = [];
        let showClustering = true;
        let showAirports = true;
        let spotsData = null;
        let allSpots = [];
        let filteredSpots = [];
        let mapLayers = {};
        let currentSearchAbortController = null; // For canceling ongoing searches
        let isSearching = false; // Flag to prevent duplicate searches
        let malaysiaData = null; // States and districts data
        
        // API configuration
        const API_BASE_URL = (() => {
            const hostname = window.location.hostname;
            const port = window.location.port || '8001';
            if (hostname && hostname !== 'localhost' && hostname !== '127.0.0.1') {
                return `${window.location.protocol}//${hostname}:${port}`;
            }
            return 'http://localhost:8001';
        })();
        
        // Initialize map
        function initMap() {
            if (typeof L === 'undefined') {
                console.error('Leaflet.js library not loaded!');
                alert('Error: Leaflet.js map library failed to load.');
                return;
            }
            
            // Center point to show both Peninsular Malaysia and Borneo (Sabah & Sarawak)
            const defaultCenter = [3.5, 110.0]; // Centered to show all of Malaysia
            
            // Malaysia boundaries (restrict map to Malaysia only, including Sabah & Sarawak)
            const malaysiaBounds = [
                [0.5, 99.0],   // Southwest corner (south, west) - includes southern Sarawak
                [7.6, 119.5]   // Northeast corner (north, east) - includes northern Sabah
            ];
            
            leafletMap = L.map('leafletMapContainer', {
                center: defaultCenter,
                zoom: 6, // Zoomed in to focus on Malaysia including Sabah & Sarawak
                scrollWheelZoom: true,
                wheelPxPerZoomLevel: 120, // Less sensitive zoom (default is 60, higher = less sensitive)
                zoomSnap: 0.5, // Smoother zoom increments
                zoomDelta: 1, // Zoom step size
                maxBounds: malaysiaBounds, // Restrict panning to Malaysia (including Sabah & Sarawak)
                maxBoundsViscosity: 1.0, // Prevent panning outside bounds
                minZoom: 5, // Prevent zooming out beyond Malaysia bounds
                maxZoom: 18 // Maximum zoom level
            });
            
            // Set view bounds to Malaysia
            leafletMap.setMaxBounds(malaysiaBounds);
            
            // Create map layers
            mapLayers.terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                maxZoom: 17,
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                subdomains: ['a', 'b', 'c']
            });
            
            mapLayers.street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                subdomains: ['a', 'b', 'c']
            });
            
            mapLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            });
            
            mapLayers.satellite.addTo(leafletMap);
            
            // Add layer control
            L.control.layers({
                "Terrain": mapLayers.terrain,
                "Street": mapLayers.street,
                "Satellite": mapLayers.satellite
            }).addTo(leafletMap);
            
            // Initialize marker cluster group
            markerCluster = L.markerClusterGroup({
                chunkedLoading: true,
                maxClusterRadius: 50
            });
            
            // Event handlers
            document.getElementById('btnClustering').addEventListener('click', toggleClustering);
            document.getElementById('btnAirports').addEventListener('click', toggleAirports);
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            
            // Enforce minimum zoom to prevent showing areas outside Malaysia
            leafletMap.on('zoomend', () => {
                const currentZoom = leafletMap.getZoom();
                // If zoomed out too far, enforce minimum zoom
                if (currentZoom < 5) {
                    leafletMap.setZoom(5);
                }
            });
            
            console.log('Enhanced map initialized with clustering support');
        }
        
        // Toggle marker clustering
        function toggleClustering() {
            showClustering = !showClustering;
            updateMarkers();
            document.getElementById('btnClustering').textContent = showClustering ? 'Disable Clustering' : 'Enable Clustering';
        }
        
        // Toggle airport display
        function toggleAirports() {
            showAirports = !showAirports;
            if (showAirports) {
                airportCircles.forEach(circle => circle.addTo(leafletMap));
                airportMarkers.forEach(marker => marker.addTo(leafletMap));
            } else {
                airportCircles.forEach(circle => leafletMap.removeLayer(circle));
                airportMarkers.forEach(marker => leafletMap.removeLayer(marker));
            }
            document.getElementById('btnAirports').textContent = showAirports ? 'Hide Airports' : 'Show Airports';
        }
        
        // Toggle mobile menu
        function toggleMobileMenu() {
            const menu = document.getElementById('navMenu');
            menu.classList.toggle('hidden');
        }
        
        // Load and display spots
        function loadMapData(data = null) {
            if (data) {
                spotsData = data;
                displaySpots(data);
            }
        }
        
        // Display spots on map
        function displaySpots(data) {
            // Clear existing markers
            if (markerCluster) {
                markerCluster.clearLayers();
                leafletMap.removeLayer(markerCluster);
            }
            leafletMarkers = [];
            
            if (!data || !data.spots || data.spots.length === 0) {
                console.log('No spots to display');
                return;
            }
            
            allSpots = data.spots;
            filteredSpots = [...allSpots];
            
            // Create markers (droneDirectory style - camera icons)
            data.spots.forEach((spot, index) => {
                const marker = L.marker([spot.latitude, spot.longitude], {
                    icon: createSpotIcon(spot),
                    title: spot.name || 'Drone Spot' // Tooltip on hover
                });
                
                // Add popup with better styling
                const popupContent = createPopupContent(spot);
                marker.bindPopup(popupContent, {
                    className: 'custom-popup',
                    maxWidth: 250,
                    closeButton: true
                });
                
                // Show popup on hover for better visibility (like droneDirectory)
                marker.on('mouseover', function() {
                    this.openPopup();
                });
                
                // Zoom in when marker is clicked
                marker.on('click', function() {
                    const spotLatLng = [spot.latitude, spot.longitude];
                    leafletMap.setView(spotLatLng, 15, {
                        animate: true,
                        duration: 0.5
                    });
                    this.openPopup();
                });
                
                leafletMarkers.push(marker);
            });
            
            // Add markers to cluster or map
            if (showClustering && markerCluster) {
                leafletMarkers.forEach(marker => markerCluster.addLayer(marker));
                markerCluster.addTo(leafletMap);
            } else {
                leafletMarkers.forEach(marker => marker.addTo(leafletMap));
            }
            
            // Fit map to bounds (but stay within Malaysia)
            if (leafletMarkers.length > 0) {
                const group = new L.featureGroup(leafletMarkers);
                const markersBounds = group.getBounds();
                
                // Ensure bounds stay within Malaysia (including Sabah & Sarawak)
                const malaysiaBounds = L.latLngBounds(
                    [0.5, 99.0],   // Southwest (includes southern Sarawak)
                    [7.6, 119.5]   // Northeast (includes northern Sabah)
                );
                
                // Clip marker bounds to Malaysia bounds
                const clippedBounds = L.latLngBounds(
                    [
                        Math.max(markersBounds.getSouth(), malaysiaBounds.getSouth()),
                        Math.max(markersBounds.getWest(), malaysiaBounds.getWest())
                    ],
                    [
                        Math.min(markersBounds.getNorth(), malaysiaBounds.getNorth()),
                        Math.min(markersBounds.getEast(), malaysiaBounds.getEast())
                    ]
                );
                
                leafletMap.fitBounds(clippedBounds.pad(0.1), {
                    maxZoom: 15, // Don't zoom in too much when fitting
                    minZoom: 5 // Ensure we don't zoom out beyond Malaysia bounds
                });
            } else {
                // If no markers, center on Malaysia (showing all including Sabah & Sarawak)
                leafletMap.setView([3.5, 110.0], 6);
            }
            
            // Load airports if query location exists
            if (data.query_location) {
                loadAirports(data.query_location.latitude, data.query_location.longitude, data.search_radius_km || 15);
            }
            
            // Update sidebar
            updateSidebar();
        }
        
        // Create custom spot icon (droneDirectory style - camera icon)
        function createSpotIcon(spot) {
            // Use droneDirectory's blue color (#0047AB) for all markers
            const color = '#0047AB';
            
            // Camera icon SVG (similar to droneDirectory)
            const cameraIconSVG = `
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.293 4.293A1 1 0 0 1 9 4h6a1 1 0 0 1 .707.293L17.414 6H20a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2.586l1.707-1.707zM9.414 6L7.707 7.707A1 1 0 0 1 7 8H4v10h16V8h-3a1 1 0 0 1-.707-.293L14.586 6H9.414zM12 10.5a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-4 2a4 4 0 1 1 8 0 4 4 0 0 1-8 0z" 
                          fill="${color}" 
                          stroke="white" 
                          stroke-width="1"/>
                </svg>
            `;
            
            return L.divIcon({
                className: 'custom-marker-icon',
                html: `
                    <div style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: white;
                        border-radius: 50%;
                        padding: 4px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        border: 2px solid white;
                    ">
                        ${cameraIconSVG}
                    </div>
                `,
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
        }
        
        // Create popup content
        function createPopupContent(spot) {
            const safetyColor = spot.safety_score >= 8 ? '#28a745' : spot.safety_score >= 5 ? '#ffc107' : '#dc3545';
            
            // Generate Google Maps navigation URL (directions mode)
            const mapsUrl = spot.google_maps_url || 
                          `https://www.google.com/maps?q=${spot.latitude},${spot.longitude}`;
            // Use directions URL for navigation (will open in navigation mode on mobile)
            const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${spot.latitude},${spot.longitude}`;
            
            return `
                <div style="min-width: 200px;">
                    <h3 style="font-weight: bold; margin-bottom: 5px;">${spot.name || 'Unnamed Spot'}</h3>
                    <p style="margin: 5px 0; color: #666; font-size: 12px;">${spot.address || 'No address'}</p>
                    <div style="margin: 8px 0;">
                        <span style="background: ${safetyColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">
                            Safety: ${spot.safety_score?.toFixed(1) || 'N/A'}
                        </span>
                    </div>
                    <div style="margin-top: 10px;">
                        <a href="${navUrl}" 
                           target="_blank" 
                           rel="noopener noreferrer"
                           style="
                               display: inline-block;
                               background-color: #4285F4;
                               color: white;
                               padding: 6px 12px;
                               border-radius: 4px;
                               text-decoration: none;
                               font-size: 12px;
                               font-weight: 500;
                               transition: background-color 0.2s;
                           "
                           onmouseover="this.style.backgroundColor='#3367D6'"
                           onmouseout="this.style.backgroundColor='#4285F4'"
                        >
                            üó∫Ô∏è Navigate with Google Maps
                        </a>
                    </div>
                    ${spot.no_fly_zones_nearby && spot.no_fly_zones_nearby.length > 0 ? 
                        `<p style="color: #dc3545; margin-top: 8px; font-size: 12px;">‚ö†Ô∏è ${spot.no_fly_zones_nearby.length} no-fly zone(s) nearby</p>` : ''}
                </div>
            `;
        }
        
        // Load airports and display restrictions
        async function loadAirports(lat, lon, radiusKm) {
            try {
                const response = await fetch(`${API_BASE_URL}/no-fly-zones?latitude=${lat}&longitude=${lon}&radius_km=${radiusKm * 2}`);
                const data = await response.json();
                
                // Debug: Log the API response structure
                console.log('No-fly zones API response:', data);
                
                // Clear existing airports
                airportCircles.forEach(circle => leafletMap.removeLayer(circle));
                airportMarkers.forEach(marker => leafletMap.removeLayer(marker));
                airportCircles = [];
                airportMarkers = [];
                
                // Get airports from the correct path in API response
                const airports = data.no_fly_zones?.airports || [];
                if (airports.length > 0) {
                    airports.forEach(airport => {
                        // Draw 5km radius circle
                        const circle = L.circle([airport.lat, airport.lon], {
                            radius: 5000, // 5km
                            color: '#FF0000',
                            fillColor: '#FF0000',
                            fillOpacity: 0.2,
                            weight: 2,
                            className: 'airport-circle'
                        });
                        
                        // Add airport marker
                        const airportIcon = L.divIcon({
                            className: 'custom-marker-icon',
                            html: `<div style="
                                background-color: #000;
                                width: 16px;
                                height: 16px;
                                border-radius: 50%;
                                border: 2px solid white;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                            "></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        });
                        
                        const marker = L.marker([airport.lat, airport.lon], {
                            icon: airportIcon
                        }).bindPopup(`<strong>${airport.name}</strong><br>Airport - 5km no-fly zone`);
                        
                        if (showAirports) {
                            circle.addTo(leafletMap);
                            marker.addTo(leafletMap);
                        }
                        
                        airportCircles.push(circle);
                        airportMarkers.push(marker);
                    });
                }
                
                // Display military areas
                const militaryAreas = data.no_fly_zones?.military_areas || [];
                if (militaryAreas.length > 0) {
                    militaryAreas.forEach(military => {
                        // Draw 3km radius circle for military areas
                        const circle = L.circle([military.lat, military.lon], {
                            radius: 3000, // 3km
                            color: '#FF6600',
                            fillColor: '#FF6600',
                            fillOpacity: 0.2,
                            weight: 2,
                            className: 'military-circle'
                        });
                        
                        // Add military marker
                        const militaryIcon = L.divIcon({
                            className: 'custom-marker-icon',
                            html: `<div style="
                                background-color: #8B0000;
                                width: 16px;
                                height: 16px;
                                border-radius: 50%;
                                border: 2px solid white;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                            "></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        });
                        
                        const marker = L.marker([military.lat, military.lon], {
                            icon: militaryIcon
                        }).bindPopup(`<strong>${military.name}</strong><br>Military Area - 3km no-fly zone`);
                        
                        if (showAirports) {
                            circle.addTo(leafletMap);
                            marker.addTo(leafletMap);
                        }
                        
                        airportCircles.push(circle);
                        airportMarkers.push(marker);
                    });
                }
                
                console.log(`Loaded ${airports.length} airports and ${militaryAreas.length} military areas`);
            } catch (error) {
                console.error('Error loading airports:', error);
            }
        }
        
        // Focus on a spot when clicked from sidebar
        function focusSpot(originalIndex, filteredIndex) {
            const spot = filteredSpots[filteredIndex];
            if (!spot || !leafletMap) return;
            
            // Zoom in to the spot (zoom level 15 for good detail)
            const spotLatLng = [spot.latitude, spot.longitude];
            leafletMap.setView(spotLatLng, 15, {
                animate: true,
                duration: 0.5
            });
            
            // Open popup on the marker if it exists
            const marker = leafletMarkers.find(m => {
                const latLng = m.getLatLng();
                return Math.abs(latLng.lat - spot.latitude) < 0.0001 && 
                       Math.abs(latLng.lng - spot.longitude) < 0.0001;
            });
            if (marker) {
                marker.openPopup();
            }
        }
        
        // Make focusSpot globally accessible
        window.focusSpot = focusSpot;
        
        // Update markers (for clustering toggle)
        function updateMarkers() {
            if (markerCluster) {
                markerCluster.clearLayers();
                leafletMap.removeLayer(markerCluster);
            }
            
            leafletMarkers.forEach(marker => {
                if (leafletMap.hasLayer(marker)) {
                    leafletMap.removeLayer(marker);
                }
            });
            
            if (showClustering && markerCluster) {
                leafletMarkers.forEach(marker => markerCluster.addLayer(marker));
                markerCluster.addTo(leafletMap);
            } else {
                leafletMarkers.forEach(marker => marker.addTo(leafletMap));
            }
        }
        
        // Filter spots
        function filterSpots() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            filteredSpots = allSpots.filter(spot => {
                const name = (spot.name || '').toLowerCase();
                const address = (spot.address || '').toLowerCase();
                const terrain = (spot.terrain_type || '').toLowerCase();
                return name.includes(query) || address.includes(query) || terrain.includes(query);
            });
            
            updateSidebar();
            updateMapMarkers();
        }
        
        // Update sidebar
        function updateSidebar() {
            const listEl = document.getElementById('spotsList');
            const statsEl = document.getElementById('stats');
            const totalEl = document.getElementById('totalSpots');
            const avgEl = document.getElementById('avgSafety');
            
            if (filteredSpots.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center p-4">No spots found</p>';
                statsEl.classList.add('hidden');
                return;
            }
            
            // Calculate stats
            const avgSafety = filteredSpots.reduce((sum, spot) => sum + (spot.safety_score || 0), 0) / filteredSpots.length;
            totalEl.textContent = filteredSpots.length;
            avgEl.textContent = avgSafety.toFixed(1);
            statsEl.classList.remove('hidden');
            
            // Render spots
            listEl.innerHTML = filteredSpots.map((spot, index) => {
                const safetyColor = spot.safety_score >= 8 ? 'bg-green-100 text-green-800' : 
                                   spot.safety_score >= 5 ? 'bg-yellow-100 text-yellow-800' : 
                                   'bg-red-100 text-red-800';
                
                // Generate Google Maps navigation URL
                const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${spot.latitude},${spot.longitude}`;
                
                return `
                    <div class="mb-4 p-4 border border-gray-200 rounded-lg hover:shadow-md">
                        <div class="cursor-pointer" onclick="focusSpot(${index}, ${index})">
                            <h3 class="font-bold text-lg mb-2">${spot.name || 'Unnamed Spot'}</h3>
                            <p class="text-sm text-gray-600 mb-2">${spot.address || 'No address'}</p>
                            <div class="flex justify-between items-center mb-2">
                                <span class="px-2 py-1 rounded text-xs ${safetyColor}">
                                    Safety: ${spot.safety_score?.toFixed(1) || 'N/A'}
                                </span>
                                <span class="text-xs text-gray-500">${spot.distance_km?.toFixed(1) || 'N/A'} km</span>
                            </div>
                            ${spot.no_fly_zones_nearby && spot.no_fly_zones_nearby.length > 0 ? 
                                `<p class="text-xs text-red-600 mb-2">‚ö†Ô∏è ${spot.no_fly_zones_nearby.length} no-fly zone(s) nearby</p>` : ''}
                        </div>
                        <a href="${navUrl}" 
                           target="_blank" 
                           rel="noopener noreferrer"
                           class="inline-block w-full text-center bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium transition-colors"
                           onclick="event.stopPropagation();"
                        >
                            üó∫Ô∏è Navigate with Google Maps
                        </a>
                    </div>
                `;
            }).join('');
        }
        
        // Update map markers based on filtered spots
        function updateMapMarkers() {
            // Remove all markers
            if (markerCluster) {
                markerCluster.clearLayers();
                leafletMap.removeLayer(markerCluster);
            }
            leafletMarkers.forEach(marker => {
                if (leafletMap.hasLayer(marker)) {
                    leafletMap.removeLayer(marker);
                }
            });
            
            // Add filtered markers
            const filteredMarkers = leafletMarkers.filter((marker, index) => {
                return filteredSpots.some(spot => 
                    Math.abs(spot.latitude - marker.getLatLng().lat) < 0.0001 &&
                    Math.abs(spot.longitude - marker.getLatLng().lng) < 0.0001
                );
            });
            
            if (showClustering && markerCluster) {
                filteredMarkers.forEach(marker => markerCluster.addLayer(marker));
                markerCluster.addTo(leafletMap);
            } else {
                filteredMarkers.forEach(marker => marker.addTo(leafletMap));
            }
        }
        
        // Search location and load spots (Malaysia only)
        async function searchLocation() {
            // Prevent duplicate searches
            if (isSearching) {
                console.log('Search already in progress, ignoring duplicate request');
                return;
            }
            
            const locationInput = document.getElementById('locationSearch');
            const location = locationInput.value.trim();
            const searchBtn = document.getElementById('searchBtn');
            
            if (!location) {
                alert('Please enter a location in Malaysia (e.g., "Kuala Lumpur", "Penang", "Kota Kinabalu", "Kuching")');
                return;
            }
            
            // Cancel any ongoing search
            if (currentSearchAbortController) {
                currentSearchAbortController.abort();
            }
            
            // Create new abort controller for this search
            currentSearchAbortController = new AbortController();
            const signal = currentSearchAbortController.signal;
            
            // Set searching flag
            isSearching = true;
            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';
            
            // Clear previous results and error messages immediately
            allSpots = [];
            filteredSpots = [];
            spotsData = null;
            
            // Clear existing markers before starting new search
            if (markerCluster) {
                markerCluster.clearLayers();
                leafletMap.removeLayer(markerCluster);
            }
            leafletMarkers.forEach(marker => {
                if (leafletMap.hasLayer(marker)) {
                    leafletMap.removeLayer(marker);
                }
            });
            leafletMarkers = [];
            
            // Update sidebar to show empty state
            updateSidebar();
            
            try {
                // Improve search query formatting using states/districts data
                let searchQuery = location.trim();
                let stateParam = null;
                let districtParam = null;
                
                // Try to find state/district info if we have the data
                if (malaysiaData) {
                    const locationInfo = findLocationInfo(searchQuery);
                    if (locationInfo) {
                        stateParam = locationInfo.state;
                        districtParam = locationInfo.district;
                        
                        // Build better search query
                        if (districtParam) {
                            searchQuery = `${searchQuery}, ${stateParam}, Malaysia`;
                        } else if (stateParam) {
                            // If it's a state name, use state parameter instead
                            if (stateParam.toLowerCase() === searchQuery.toLowerCase()) {
                                // User searched for state name, use state parameter
                                stateParam = stateParam;
                                searchQuery = null; // Will use state parameter
                            } else {
                                searchQuery = `${searchQuery}, ${stateParam}, Malaysia`;
                            }
                        }
                    }
                }
                
                // If location doesn't already include Malaysia, add it
                if (searchQuery && !searchQuery.toLowerCase().includes('malaysia')) {
                    searchQuery = `${searchQuery}, Malaysia`;
                }
                
                // Build API URL with parameters
                let apiUrl = `${API_BASE_URL}/search?radius_km=20&max_results=50`;
                
                if (stateParam && !searchQuery) {
                    // Search by state only
                    apiUrl += `&state=${encodeURIComponent(stateParam)}`;
                } else if (searchQuery) {
                    // Search by address
                    apiUrl += `&address=${encodeURIComponent(searchQuery)}`;
                    if (stateParam) {
                        apiUrl += `&state=${encodeURIComponent(stateParam)}`;
                    }
                    if (districtParam) {
                        apiUrl += `&district=${encodeURIComponent(districtParam)}`;
                    }
                }
                
                const response = await fetch(apiUrl, {
                    signal: signal // Add abort signal
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Debug: Log the API response
                console.log('API Response:', {
                    hasSpots: !!data.spots,
                    spotsLength: data.spots?.length || 0,
                    totalSpotsFound: data.total_spots_found || 0,
                    queryLocation: data.query_location,
                    searchRadius: data.search_radius_km
                });
                
                // Check if request was aborted after fetch completes
                if (signal.aborted) {
                    console.log('Search was cancelled after data received');
                    return;
                }
                
                // Process results only if request wasn't aborted
                if (data.spots && data.spots.length > 0) {
                    // Filter spots to ensure they're within Malaysia bounds (including Sabah & Sarawak)
                    const malaysiaBounds = L.latLngBounds([0.5, 99.0], [7.6, 119.5]);
                    const validSpots = data.spots.filter(spot => {
                        const lat = spot.latitude;
                        const lon = spot.longitude;
                        return lat >= 0.5 && lat <= 7.6 && lon >= 99.0 && lon <= 119.5;
                    });
                    
                    // Check again if request was aborted after filtering
                    if (signal.aborted) {
                        console.log('Search was cancelled after filtering');
                        return;
                    }
                    
                    if (validSpots.length > 0) {
                        data.spots = validSpots;
                        data.total_spots_found = validSpots.length;
                        loadMapData(data);
                        locationInput.value = '';
                        console.log(`Found ${validSpots.length} drone spots in Malaysia!`);
                    } else {
                        // Only show error after all processing is complete and request wasn't aborted
                        alert('No valid spots found within Malaysia. Please search for a location in Malaysia (including Sabah & Sarawak).');
                    }
                } else {
                    // Only show error after all processing is complete
                    // Provide more helpful error message with debugging info
                    const originalLocation = location.trim();
                    
                    // Try to suggest state/district format if we have the data
                    let suggestion = '';
                    if (malaysiaData) {
                        const locationInfo = findLocationInfo(originalLocation);
                        if (locationInfo && locationInfo.state && !originalLocation.toLowerCase().includes(locationInfo.state.toLowerCase())) {
                            suggestion = `\n- Try: "${originalLocation}, ${locationInfo.state}"`;
                        }
                    }
                    
                    const errorMsg = data.total_spots_found === 0 
                        ? `No spots found for "${originalLocation}". The API searched but found no suitable drone spots in the area.\n\nTry:\n- A larger city or well-known location (e.g., "Kuala Lumpur", "Penang", "Johor Bahru")${suggestion}\n- Adding the state name (e.g., "Kulim, Kedah")\n- A different location in Malaysia\n- Increasing the search radius`
                        : `No spots found for "${originalLocation}". Please try a different location in Malaysia (including Sabah & Sarawak).${suggestion}`;
                    console.warn('No spots in response:', data);
                    console.log('Search query used:', searchQuery || 'State/District search');
                    if (stateParam) console.log('State parameter:', stateParam);
                    if (districtParam) console.log('District parameter:', districtParam);
                    alert(errorMsg);
                }
            } catch (error) {
                // Don't show error for aborted requests
                if (error.name === 'AbortError' || signal.aborted) {
                    console.log('Search was aborted');
                    return; // Return early, finally block will still execute
                }
                
                // Only show error if request wasn't aborted
                console.error('Search error:', error);
                alert(`Error searching: ${error.message}\n\nMake sure the API is running at ${API_BASE_URL}\n\nNote: This map only shows locations in Malaysia (including Sabah & Sarawak).`);
            } finally {
                // Always reset button state, but only clear abort controller if this was the current search
                if (currentSearchAbortController === signal) {
                    isSearching = false;
                    currentSearchAbortController = null;
                }
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
            }
        }
        
        // Load Malaysia states and districts data
        async function loadMalaysiaData() {
            try {
                const response = await fetch('malaysia_states_districts.json');
                if (response.ok) {
                    malaysiaData = await response.json();
                    console.log('Loaded Malaysia states and districts data');
                } else {
                    console.warn('Could not load malaysia_states_districts.json, continuing without it');
                }
            } catch (error) {
                console.warn('Error loading malaysia_states_districts.json:', error);
            }
        }
        
        // Find state and district for a location name
        function findLocationInfo(locationName) {
            if (!malaysiaData) return null;
            
            const searchName = locationName.toLowerCase().trim();
            
            // Search through all states
            for (const state of malaysiaData.states) {
                // Check if it's a state name
                if (state.name.toLowerCase() === searchName) {
                    return { state: state.name, district: null };
                }
                
                // Check districts
                for (const district of state.districts) {
                    if (district.toLowerCase() === searchName) {
                        return { state: state.name, district: district };
                    }
                }
                
                // Check major cities
                for (const city of state.major_cities) {
                    if (city.toLowerCase() === searchName) {
                        // Try to find matching district
                        const matchingDistrict = state.districts.find(d => 
                            d.toLowerCase().includes(searchName) || 
                            searchName.includes(d.toLowerCase())
                        );
                        return { 
                            state: state.name, 
                            district: matchingDistrict || null 
                        };
                    }
                }
                
                // Partial match for districts
                for (const district of state.districts) {
                    if (district.toLowerCase().includes(searchName) || 
                        searchName.includes(district.toLowerCase())) {
                        return { state: state.name, district: district };
                    }
                }
            }
            
            return null;
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            initMap();
            await loadMalaysiaData();
            
            // Allow Enter key to trigger search
            const locationSearch = document.getElementById('locationSearch');
            if (locationSearch) {
                locationSearch.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchLocation();
                    }
                });
            }
        });
        
        // Expose loadMapData for external use
        window.loadMapData = loadMapData;
        window.searchLocation = searchLocation;
    </script>
</body>
</html>

