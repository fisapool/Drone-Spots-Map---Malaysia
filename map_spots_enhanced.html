<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Spots Map - Enhanced (Malaysia)</title>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <style>
        /* Reset html and body margins to ensure header is at top */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden;
        }
        
        /* White layer to cover any gap at top */
        .header-white-layer {
            position: fixed;
            top: -10px;
            left: 0;
            right: 0;
            height: 20px;
            background: white;
            z-index: 49;
        }
        
        /* Ensure nav is at the very top */
        nav.border-4 {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            margin: 0 !important;
            margin-top: 0 !important;
            transform: translateY(0) !important;
        }
        
        /* Custom styles for enhanced map */
        .spot-detail-card {
            transition: all 0.3s ease;
        }
        .spot-detail-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .airport-circle {
            stroke-dasharray: 5, 5;
            animation: dash 20s linear infinite;
        }
        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }
        .custom-marker-icon {
            background: transparent;
            border: none;
        }
    </style>
</head>
<body class="bg-zinc-100">
    <!-- White layer to cover any gap at top -->
    <div class="header-white-layer"></div>
    
    <!-- Enhanced Navigation Bar (inspired by droneDirectory) -->
    <nav class="border-4 border-black bg-zinc-200 w-full fixed top-0 left-0 right-0 z-50" style="position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; margin: 0 !important; margin-top: 0 !important;">
        <div class="md:flex md:justify-between items-center p-3">
            <div class="flex items-center justify-between w-full md:w-auto">
                <a href="#" class="text-xl font-semibold flex gap-2 items-center justify-center group">
                    <span class="text-2xl">üöÅ</span>
                    <span class="hidden md:inline">Drone Spots Malaysia</span>
                </a>
                <button id="mobileMenuBtn" class="text-3xl md:hidden">‚ò∞</button>
            </div>
            <div id="navMenu" class="hidden md:flex items-center gap-5">
                <button id="btnClustering" class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800">
                    Toggle Clustering
                </button>
                <button id="btnAirports" class="px-4 py-2 border border-black rounded hover:border-gray-400">
                    Toggle Airports
                </button>
            </div>
        </div>
    </nav>
    
    <div class="flex flex-col h-screen pt-16">
        <div class="flex flex-1 overflow-hidden">
            <!-- Map Container -->
            <div id="leafletMapContainer" class="flex-1 w-full h-full"></div>
            
            <!-- Enhanced Sidebar -->
            <div id="sidebar" class="w-96 bg-white shadow-lg overflow-y-auto hidden md:block">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-2xl font-bold mb-2">Drone Spots</h2>
                    <p class="text-sm text-gray-600">Click markers to view details</p>
                </div>
                
                <!-- Search Section -->
                <div class="p-4 border-b border-gray-200">
                    <input 
                        type="search" 
                        id="searchInput" 
                        placeholder="Search by name, address, postal code, or terrain..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                        oninput="filterSpots()"
                    />
                    <div id="searchResultsInfo" class="mt-2 text-sm text-gray-600 hidden"></div>
                </div>
                
                <!-- Stats Section -->
                <div id="stats" class="p-4 border-b border-gray-200 grid grid-cols-2 gap-4 hidden">
                    <div class="bg-zinc-100 p-3 rounded">
                        <div class="text-2xl font-bold" id="totalSpots">0</div>
                        <div class="text-sm text-gray-600">Total Spots</div>
                    </div>
                    <div class="bg-zinc-100 p-3 rounded">
                        <div class="text-2xl font-bold" id="avgSafety">0</div>
                        <div class="text-sm text-gray-600">Avg Safety</div>
                    </div>
                </div>
                
                <!-- Spots List -->
                <div id="spotsList" class="p-4"></div>
            </div>
        </div>
        
        <!-- Spot Detail Card (Enhanced, inspired by droneDirectory) -->
        <div id="spotDetailCard" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 z-40 w-full max-w-2xl">
            <div class="bg-white rounded-lg shadow-xl p-6 mx-4 spot-detail-card">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 id="spotDetailName" class="text-2xl font-bold mb-2"></h3>
                        <div id="spotDetailInfo" class="text-sm text-gray-600"></div>
                    </div>
                    <button id="closeDetailCard" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>
                <div id="spotDetailContent" class="space-y-3"></div>
                <div class="mt-4 flex gap-2">
                    <button id="navigateBtn" class="px-4 py-2 border border-black rounded hover:border-gray-400 flex items-center gap-2">
                        <span>üß≠</span> Navigate
                    </button>
                    <button id="shareBtn" class="px-4 py-2 border border-black rounded hover:border-gray-400 flex items-center gap-2">
                        <span>üîó</span> Share
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet.js -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet MarkerCluster -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script>
        let leafletMap = null;
        let markerCluster = null; // Marker cluster group
        let leafletMarkers = [];
        let airportMarkers = [];
        let airportCircles = [];
        let showClustering = true;
        let showAirports = true;
        let spotsData = null;
        let allSpots = [];
        let filteredSpots = [];
        let selectedSpot = null;
        let mapLayers = {};
        
        // API configuration
        const API_BASE_URL = (() => {
            const hostname = window.location.hostname;
            const port = window.location.port || '8001';
            if (hostname && hostname !== 'localhost' && hostname !== '127.0.0.1') {
                return `${window.location.protocol}//${hostname}:${port}`;
            }
            return 'http://localhost:8001';
        })();
        
        // Initialize map
        function initMap() {
            if (typeof L === 'undefined') {
                console.error('Leaflet.js library not loaded!');
                alert('Error: Leaflet.js map library failed to load.');
                return;
            }
            
            const defaultCenter = [5.737, 100.417]; // Malaysia center
            
            leafletMap = L.map('leafletMapContainer', {
                center: defaultCenter,
                zoom: 12,
                scrollWheelZoom: true
            });
            
            // Create map layers
            mapLayers.terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                maxZoom: 17,
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                subdomains: ['a', 'b', 'c']
            });
            
            mapLayers.street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                subdomains: ['a', 'b', 'c']
            });
            
            mapLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            });
            
            mapLayers.terrain.addTo(leafletMap);
            
            // Add layer control
            L.control.layers({
                "Terrain": mapLayers.terrain,
                "Street": mapLayers.street,
                "Satellite": mapLayers.satellite
            }).addTo(leafletMap);
            
            // Initialize marker cluster group
            markerCluster = L.markerClusterGroup({
                chunkedLoading: true,
                maxClusterRadius: 50
            });
            
            // Event handlers
            document.getElementById('btnClustering').addEventListener('click', toggleClustering);
            document.getElementById('btnAirports').addEventListener('click', toggleAirports);
            document.getElementById('closeDetailCard').addEventListener('click', closeDetailCard);
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            
            console.log('Enhanced map initialized with clustering support');
        }
        
        // Toggle marker clustering
        function toggleClustering() {
            showClustering = !showClustering;
            updateMarkers();
            document.getElementById('btnClustering').textContent = showClustering ? 'Disable Clustering' : 'Enable Clustering';
        }
        
        // Toggle airport display
        function toggleAirports() {
            showAirports = !showAirports;
            if (showAirports) {
                airportCircles.forEach(circle => circle.addTo(leafletMap));
                airportMarkers.forEach(marker => marker.addTo(leafletMap));
            } else {
                airportCircles.forEach(circle => leafletMap.removeLayer(circle));
                airportMarkers.forEach(marker => leafletMap.removeLayer(marker));
            }
            document.getElementById('btnAirports').textContent = showAirports ? 'Hide Airports' : 'Show Airports';
        }
        
        // Toggle mobile menu
        function toggleMobileMenu() {
            const menu = document.getElementById('navMenu');
            menu.classList.toggle('hidden');
        }
        
        // Load and display spots
        function loadMapData(data = null) {
            if (data) {
                spotsData = data;
                displaySpots(data);
            }
        }
        
        // Display spots on map
        function displaySpots(data) {
            // Clear existing markers
            if (markerCluster) {
                markerCluster.clearLayers();
                leafletMap.removeLayer(markerCluster);
            }
            leafletMarkers = [];
            
            if (!data || !data.spots || data.spots.length === 0) {
                console.log('No spots to display');
                return;
            }
            
            allSpots = data.spots;
            filteredSpots = [...allSpots];
            
            // Create markers
            data.spots.forEach((spot, index) => {
                const marker = L.marker([spot.latitude, spot.longitude], {
                    icon: createSpotIcon(spot)
                });
                
                // Add popup
                const popupContent = createPopupContent(spot);
                marker.bindPopup(popupContent);
                
                // Add click handler
                marker.on('click', () => {
                    showSpotDetail(spot);
                });
                
                leafletMarkers.push(marker);
            });
            
            // Add markers to cluster or map
            if (showClustering && markerCluster) {
                leafletMarkers.forEach(marker => markerCluster.addLayer(marker));
                markerCluster.addTo(leafletMap);
            } else {
                leafletMarkers.forEach(marker => marker.addTo(leafletMap));
            }
            
            // Fit map to bounds
            if (leafletMarkers.length > 0) {
                const group = new L.featureGroup(leafletMarkers);
                leafletMap.fitBounds(group.getBounds().pad(0.1));
            }
            
            // Load airports if query location exists
            if (data.query_location) {
                loadAirports(data.query_location.latitude, data.query_location.longitude, data.search_radius_km || 15);
            }
            
            // Update sidebar
            updateSidebar();
        }
        
        // Create custom spot icon based on safety score
        function createSpotIcon(spot) {
            const safetyScore = spot.safety_score || 5;
            let color = '#dc3545'; // Red
            if (safetyScore >= 8) color = '#28a745'; // Green
            else if (safetyScore >= 5) color = '#ffc107'; // Yellow
            
            return L.divIcon({
                className: 'custom-marker-icon',
                html: `<div style="
                    background-color: ${color};
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 2px solid white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                "></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        }
        
        // Create popup content
        function createPopupContent(spot) {
            const safetyColor = spot.safety_score >= 8 ? '#28a745' : spot.safety_score >= 5 ? '#ffc107' : '#dc3545';
            return `
                <div style="min-width: 200px;">
                    <h3 style="font-weight: bold; margin-bottom: 5px;">${spot.name || 'Unnamed Spot'}</h3>
                    <p style="margin: 5px 0; color: #666;">${spot.address || 'No address'}</p>
                    <div style="margin: 5px 0;">
                        <span style="background: ${safetyColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">
                            Safety: ${spot.safety_score?.toFixed(1) || 'N/A'}
                        </span>
                    </div>
                    ${spot.no_fly_zones_nearby && spot.no_fly_zones_nearby.length > 0 ? 
                        `<p style="color: #dc3545; margin-top: 5px; font-size: 12px;">‚ö†Ô∏è ${spot.no_fly_zones_nearby.length} no-fly zone(s) nearby</p>` : ''}
                </div>
            `;
        }
        
        // Load airports and display restrictions
        async function loadAirports(lat, lon, radiusKm) {
            try {
                const response = await fetch(`${API_BASE_URL}/no-fly-zones?latitude=${lat}&longitude=${lon}&radius_km=${radiusKm * 2}`);
                const data = await response.json();
                
                // Clear existing airports
                airportCircles.forEach(circle => leafletMap.removeLayer(circle));
                airportMarkers.forEach(marker => leafletMap.removeLayer(marker));
                airportCircles = [];
                airportMarkers = [];
                
                // Display airports
                if (data.airports && data.airports.length > 0) {
                    data.airports.forEach(airport => {
                        // Draw 5km radius circle
                        const circle = L.circle([airport.lat, airport.lon], {
                            radius: 5000, // 5km
                            color: '#FF0000',
                            fillColor: '#FF0000',
                            fillOpacity: 0.2,
                            weight: 2,
                            className: 'airport-circle'
                        });
                        
                        // Add airport marker
                        const airportIcon = L.divIcon({
                            className: 'custom-marker-icon',
                            html: `<div style="
                                background-color: #000;
                                width: 16px;
                                height: 16px;
                                border-radius: 50%;
                                border: 2px solid white;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                            "></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        });
                        
                        const marker = L.marker([airport.lat, airport.lon], {
                            icon: airportIcon
                        }).bindPopup(`<strong>${airport.name}</strong><br>Airport - 5km no-fly zone`);
                        
                        if (showAirports) {
                            circle.addTo(leafletMap);
                            marker.addTo(leafletMap);
                        }
                        
                        airportCircles.push(circle);
                        airportMarkers.push(marker);
                    });
                }
            } catch (error) {
                console.error('Error loading airports:', error);
            }
        }
        
        // Show spot detail card
        function showSpotDetail(spot) {
            selectedSpot = spot;
            const card = document.getElementById('spotDetailCard');
            const nameEl = document.getElementById('spotDetailName');
            const infoEl = document.getElementById('spotDetailInfo');
            const contentEl = document.getElementById('spotDetailContent');
            
            nameEl.textContent = spot.name || 'Unnamed Spot';
            infoEl.innerHTML = `
                <div class="flex gap-4 text-sm">
                    <span>üìç ${spot.address || 'No address'}</span>
                    <span>üìè ${spot.distance_km?.toFixed(2) || 'N/A'} km</span>
                </div>
            `;
            
            const safetyColor = spot.safety_score >= 8 ? 'text-green-600' : spot.safety_score >= 5 ? 'text-yellow-600' : 'text-red-600';
            
            contentEl.innerHTML = `
                <div class="space-y-2">
                    <div>
                        <span class="font-semibold">Safety Score: </span>
                        <span class="${safetyColor} font-bold">${spot.safety_score?.toFixed(1) || 'N/A'}/10</span>
                    </div>
                    <div>
                        <span class="font-semibold">Spot Type: </span>
                        <span>${spot.spot_type || 'Unknown'}</span>
                    </div>
                    ${spot.car_accessible !== undefined ? `
                        <div>
                            <span class="font-semibold">Car Accessible: </span>
                            <span>${spot.car_accessible ? '‚úÖ Yes' : '‚ùå No'}</span>
                        </div>
                    ` : ''}
                    ${spot.no_fly_zones_nearby && spot.no_fly_zones_nearby.length > 0 ? `
                        <div class="bg-red-50 border border-red-200 rounded p-2">
                            <span class="font-semibold text-red-700">‚ö†Ô∏è ${spot.no_fly_zones_nearby.length} no-fly zone(s) nearby:</span>
                            <ul class="list-disc list-inside text-sm text-red-600 mt-1">
                                ${spot.no_fly_zones_nearby.slice(0, 3).map(zone => `<li>${zone}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Set up navigation button
            document.getElementById('navigateBtn').onclick = () => {
                const url = `https://www.google.com/maps/dir/?api=1&destination=${spot.latitude},${spot.longitude}`;
                window.open(url, '_blank');
            };
            
            // Set up share button
            document.getElementById('shareBtn').onclick = () => {
                const url = `${window.location.href}?spot=${spot.latitude},${spot.longitude}`;
                navigator.clipboard.writeText(url).then(() => {
                    alert('Link copied to clipboard!');
                });
            };
            
            card.classList.remove('hidden');
            
            // Center map on spot
            leafletMap.setView([spot.latitude, spot.longitude], 15);
        }
        
        // Close detail card
        function closeDetailCard() {
            document.getElementById('spotDetailCard').classList.add('hidden');
            selectedSpot = null;
        }
        
        // Update markers (for clustering toggle)
        function updateMarkers() {
            if (markerCluster) {
                markerCluster.clearLayers();
                leafletMap.removeLayer(markerCluster);
            }
            
            leafletMarkers.forEach(marker => {
                if (leafletMap.hasLayer(marker)) {
                    leafletMap.removeLayer(marker);
                }
            });
            
            if (showClustering && markerCluster) {
                leafletMarkers.forEach(marker => markerCluster.addLayer(marker));
                markerCluster.addTo(leafletMap);
            } else {
                leafletMarkers.forEach(marker => marker.addTo(leafletMap));
            }
        }
        
        // Filter spots
        function filterSpots() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            // Check if query is a postal code (5 digits)
            const isPostalCode = /^\d{5}$/.test(query.replace(/\s/g, ''));
            
            filteredSpots = allSpots.filter(spot => {
                const name = (spot.name || '').toLowerCase();
                const address = (spot.address || '').toLowerCase();
                const terrain = (spot.terrain_type || '').toLowerCase();
                
                // If searching by postal code, prioritize postal code matches in address
                if (isPostalCode) {
                    // Extract postal codes from address (5-digit numbers)
                    const postalCodesInAddress = address.match(/\b\d{5}\b/g) || [];
                    if (postalCodesInAddress.some(code => code === query.replace(/\s/g, ''))) {
                        return true;
                    }
                }
                
                return name.includes(query) || address.includes(query) || terrain.includes(query);
            });
            
            // Update search results info
            const resultsInfo = document.getElementById('searchResultsInfo');
            if (query && filteredSpots.length !== allSpots.length) {
                resultsInfo.textContent = `Found ${filteredSpots.length} of ${allSpots.length} spots`;
                resultsInfo.classList.remove('hidden');
            } else {
                resultsInfo.classList.add('hidden');
            }
            
            updateSidebar();
            updateMapMarkers();
        }
        
        // Update sidebar
        function updateSidebar() {
            const listEl = document.getElementById('spotsList');
            const statsEl = document.getElementById('stats');
            const totalEl = document.getElementById('totalSpots');
            const avgEl = document.getElementById('avgSafety');
            
            if (filteredSpots.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center p-4">No spots found</p>';
                statsEl.classList.add('hidden');
                return;
            }
            
            // Calculate stats
            const avgSafety = filteredSpots.reduce((sum, spot) => sum + (spot.safety_score || 0), 0) / filteredSpots.length;
            totalEl.textContent = filteredSpots.length;
            avgEl.textContent = avgSafety.toFixed(1);
            statsEl.classList.remove('hidden');
            
            // Render spots
            listEl.innerHTML = filteredSpots.map((spot, index) => {
                const safetyColor = spot.safety_score >= 8 ? 'bg-green-100 text-green-800' : 
                                   spot.safety_score >= 5 ? 'bg-yellow-100 text-yellow-800' : 
                                   'bg-red-100 text-red-800';
                
                return `
                    <div class="mb-4 p-4 border border-gray-200 rounded-lg hover:shadow-md cursor-pointer spot-detail-card" onclick="showSpotDetail(${JSON.stringify(spot).replace(/"/g, '&quot;')})">
                        <h3 class="font-bold text-lg mb-2">${spot.name || 'Unnamed Spot'}</h3>
                        <p class="text-sm text-gray-600 mb-2">${spot.address || 'No address'}</p>
                        <div class="flex justify-between items-center">
                            <span class="px-2 py-1 rounded text-xs ${safetyColor}">
                                Safety: ${spot.safety_score?.toFixed(1) || 'N/A'}
                            </span>
                            <span class="text-xs text-gray-500">${spot.distance_km?.toFixed(1) || 'N/A'} km</span>
                        </div>
                        ${spot.no_fly_zones_nearby && spot.no_fly_zones_nearby.length > 0 ? 
                            `<p class="text-xs text-red-600 mt-2">‚ö†Ô∏è ${spot.no_fly_zones_nearby.length} no-fly zone(s) nearby</p>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Update map markers based on filtered spots
        function updateMapMarkers() {
            // Remove all markers
            if (markerCluster) {
                markerCluster.clearLayers();
                leafletMap.removeLayer(markerCluster);
            }
            leafletMarkers.forEach(marker => {
                if (leafletMap.hasLayer(marker)) {
                    leafletMap.removeLayer(marker);
                }
            });
            
            // Add filtered markers
            const filteredMarkers = leafletMarkers.filter((marker, index) => {
                return filteredSpots.some(spot => 
                    Math.abs(spot.latitude - marker.getLatLng().lat) < 0.0001 &&
                    Math.abs(spot.longitude - marker.getLatLng().lng) < 0.0001
                );
            });
            
            if (showClustering && markerCluster) {
                filteredMarkers.forEach(marker => markerCluster.addLayer(marker));
                markerCluster.addTo(leafletMap);
            } else {
                filteredMarkers.forEach(marker => marker.addTo(leafletMap));
            }
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initMap();
        });
        
        // Expose loadMapData for external use
        window.loadMapData = loadMapData;
    </script>
</body>
</html>

